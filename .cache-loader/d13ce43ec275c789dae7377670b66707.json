{"remainingRequest":"/Users/jiachen/projects/shared_diary/node_modules/_babel-loader@8.0.6@babel-loader/lib/index.js!/Users/jiachen/projects/shared_diary/src/packages/back/index.js","dependencies":[{"path":"/Users/jiachen/projects/shared_diary/src/packages/back/index.js","mtime":1574666290467},{"path":"/Users/jiachen/projects/shared_diary/node_modules/_cache-loader@1.2.5@cache-loader/dist/cjs.js","mtime":499162500000},{"path":"/Users/jiachen/projects/shared_diary/node_modules/_babel-loader@8.0.6@babel-loader/lib/index.js","mtime":499162500000}],"contextDependencies":[],"result":["import { api, request } from 'utils/api';\nimport Toast from 'vant-weapp/dist/toast/toast';\nimport { getItems, checkSelectTime, getDateStr, getWeekStr, getTimeStr } from './utils';\nconst app = getApp();\nPage({\n  data: {\n    show: false,\n    mainActiveIndex: 0,\n    activeId: -1,\n    timeDesc: '',\n    dateStr: '',\n    timeStr: '',\n    weekStr: '',\n    addressId: ''\n  },\n\n  onLoad(query = {}) {\n    const {\n      id,\n      time = '',\n      address = ''\n    } = query;\n    this.id = id;\n    this.lock = false;\n    this.edit = !!time;\n\n    if (this.edit) {\n      const d = new Date(time);\n      const addr = JSON.parse(address);\n      const weekStr = getWeekStr(0, d);\n      const timeStr = getTimeStr(d);\n      const dateStr = getDateStr(0, d);\n      const addressId = addr.id;\n      const timeDesc = dateStr + ' ' + weekStr + ' ' + timeStr;\n      const addressInfo = {};\n      addressInfo.name = addr.name;\n      addressInfo.phone = addr.phone;\n      addressInfo.address = addr.address_name + ' ' + addr.address;\n      this.setData({\n        weekStr,\n        timeStr,\n        dateStr,\n        addressId,\n        timeDesc,\n        addressInfo\n      });\n    }\n  },\n\n  onShow() {\n    this.setData({\n      items: getItems()\n    });\n\n    if (app.globalData.isSetAddress === true) {\n      const addressId = app.globalData.addressId;\n      const addressInfo = app.globalData.addressInfo;\n      this.setData({\n        addressId,\n        addressInfo\n      });\n      app.globalData.isSetAddress = false;\n    }\n  },\n\n  onSelectTime() {\n    this.setData({\n      show: true\n    });\n  },\n\n  checkTime() {\n    const day = Number(this.data.dateStr.split('-').join(''));\n    const time = Number(this.data.timeStr.split(':')[0]);\n\n    if (!checkSelectTime(day, time)) {\n      Toast('请重新选择时间');\n      const items = getItems();\n      this.setData({\n        items,\n        timeDesc: '',\n        dateStr: '',\n        timeStr: '',\n        weekStr: '',\n        mainActiveIndex: 0,\n        activeId: -1\n      });\n      return false;\n    }\n\n    return true;\n  },\n\n  onClose() {\n    this.setData({\n      show: false\n    });\n    this.checkTime();\n  },\n\n  onClickNav(e) {\n    this.setData({\n      mainActiveIndex: e.detail.index\n    });\n  },\n\n  onClickItem(e) {\n    const {\n      id: activeId,\n      dateStr,\n      timeStr,\n      weekStr\n    } = e.detail;\n    this.setData({\n      activeId,\n      dateStr,\n      timeStr,\n      weekStr,\n      timeDesc: `${dateStr} ${weekStr} ${timeStr}`\n    });\n  },\n\n  onClickConfirm() {\n    if (this.lock) return;\n    if (!this.checkTime()) return;\n    const {\n      timeDesc,\n      addressId,\n      dateStr,\n      timeStr\n    } = this.data;\n\n    if (!timeDesc) {\n      return Toast('请选择取件时间');\n    }\n\n    if (!addressId) {\n      return Toast('请选择取件地址');\n    }\n\n    const tt = timeStr.split('-')[0];\n    const time = `${dateStr} ${tt}:00`;\n    this.lock = true;\n    Toast.loading('预约中...');\n\n    if (this.edit) {\n      return request({ ...api.pre_post_back_cancel,\n        id: this.id\n      }).then(() => {\n        return request({ ...api.pre_post_back,\n          id: this.id\n        }, {\n          recomanded_post_back_address_id: this.data.addressId,\n          recomanded_post_back_time: time\n        });\n      }).then(() => {\n        Toast('预约成功');\n        setTimeout(() => {\n          this.lock = false;\n          wx.navigateBack();\n        }, 1500);\n      }).catch(err => {\n        this.lock = false;\n        Toast(err.message || err.msg || err || '预约失败');\n      });\n    }\n\n    request({ ...api.pre_post_back,\n      id: this.id\n    }, {\n      recomanded_post_back_address_id: this.data.addressId,\n      recomanded_post_back_time: time\n    }).then(() => {\n      Toast('预约成功');\n      setTimeout(() => {\n        this.lock = false;\n        wx.navigateBack();\n      }, 1500);\n    }).catch(err => {\n      this.lock = false;\n      Toast(err.message || err.msg || err || '预约失败');\n    });\n  },\n\n  navToAddress() {\n    wx.navigateTo({\n      url: '/packages/address/list/index?select=1'\n    });\n  },\n\n  onShareAppMessage() {\n    return {\n      title: '爱戴小盒，快来看看吧!',\n      path: '/pages/entry/index',\n      imageUrl: 'http://static.wx.qiaqiabox.com/slice/share/1.jpeg'\n    };\n  }\n\n});",null]}