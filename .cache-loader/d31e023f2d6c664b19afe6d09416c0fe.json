{"remainingRequest":"/Users/jiachen/projects/shared_diary/node_modules/_babel-loader@8.0.6@babel-loader/lib/index.js!/Users/jiachen/projects/shared_diary/src/packages/order-edit/index.js","dependencies":[{"path":"/Users/jiachen/projects/shared_diary/src/packages/order-edit/index.js","mtime":1574666290468},{"path":"/Users/jiachen/projects/shared_diary/node_modules/_cache-loader@1.2.5@cache-loader/dist/cjs.js","mtime":499162500000},{"path":"/Users/jiachen/projects/shared_diary/node_modules/_babel-loader@8.0.6@babel-loader/lib/index.js","mtime":499162500000}],"contextDependencies":[],"result":["import { api, request } from 'utils/api';\nimport Toast from 'vant-weapp/dist/toast/toast';\nconst path = 'http://static.wx.qiaqiabox.com/slice/questions';\nconst app = getApp();\n\nfunction fix2(value) {\n  return value < 10 ? '0' + value : value;\n}\n\nPage({\n  data: {\n    DateTitle: '预定寄盒日期',\n    AddressTitle: '小盒将寄往…',\n    typeTitle: '这次想试戴的品类',\n    needTitle: '还有需求，悄悄告诉我:',\n    endTitle: '',\n    addressId: '',\n    addressInfo: '',\n    date: '',\n    otherNeed: '',\n    tryTypes: [{\n      image: `${path}/noun_Earrings.png`,\n      text: '耳环',\n      active: false\n    }, {\n      image: `${path}/noun_necklace.png`,\n      text: '项链',\n      active: false\n    }, {\n      image: `${path}/noun_Ring.png`,\n      text: '戒指',\n      active: false\n    }, {\n      image: `${path}/noun_bracelet.png`,\n      text: '手链',\n      active: false\n    }]\n  },\n\n  onLoad(query = {}) {\n    this.edit = !!query.edit;\n    const endTitle = this.edit ? '定制爱戴小盒，还有一步之遥！' : '预约新的爱戴小盒！';\n    this.setData({\n      endTitle\n    });\n\n    if (this.edit) {\n      request(api.order_box).then(res => {\n        const {\n          order\n        } = res;\n        this.id = order.id;\n        const {\n          recomanded_send_time: date = '',\n          user_note: otherNeed = '',\n          preferred_product_type: types,\n          send_address_id: addressId\n        } = order;\n        const {\n          province,\n          city,\n          county,\n          address,\n          name,\n          phone\n        } = order.send_address_id__user_address;\n        const d = new Date(date);\n        const dd = fix2(d.getFullYear()) + fix2(d.getMonth() + 1) + fix2(d.getDate());\n        const [...copyTryTypes] = this.data.tryTypes;\n        const map = ['耳环', '项链', '戒指', '手链'];\n        types && types.split('、').forEach(item => {\n          const index = map.indexOf(item);\n          copyTryTypes[index].active = true;\n        });\n        this.setData({\n          addressInfo: {\n            name,\n            phone,\n            address: province + city + county + address\n          },\n          addressId,\n          tryTypes: copyTryTypes,\n          date: dd,\n          otherNeed\n        });\n      });\n    } else {\n      // 预约新的小盒\n      request(api.survey_info).then(res => {\n        if (res.survey.state) {\n          const list = res.survey.survey_tag_list;\n          const state = JSON.parse(res.survey.state);\n          this.list = list;\n          this.state = state;\n        }\n      }).catch(err => {\n        Toast(err.message);\n        setTimeout(() => {\n          wx.switchTab({\n            url: '/pages/question/index'\n          });\n        }, 1500);\n      });\n    }\n  },\n\n  onShow() {\n    if (app.globalData.isSetAddress === true) {\n      const addressId = app.globalData.addressId;\n      const addressInfo = app.globalData.addressInfo;\n      console.log(addressInfo);\n      this.setData({\n        addressId,\n        addressInfo\n      });\n      app.globalData.isSetAddress === false;\n    }\n  },\n\n  onClickDate(e) {\n    const date = e.detail;\n    this.setData({\n      date\n    });\n  },\n\n  onClickAddress() {\n    wx.navigateTo({\n      url: '/packages/address/list/index?select=1'\n    });\n  },\n\n  onClickTryType(e) {\n    const [...copyTryTypes] = this.data.tryTypes;\n    const {\n      choose\n    } = e.target.dataset;\n    let count = 0;\n    let index = -1;\n\n    for (let i = 0; i < copyTryTypes.length; i++) {\n      if (copyTryTypes[i].active) {\n        count++;\n        index = i;\n      }\n    }\n\n    if (count === 1 && index === choose) {\n      return;\n    }\n\n    copyTryTypes[choose].active = !copyTryTypes[choose].active;\n    this.setData({\n      tryTypes: copyTryTypes\n    });\n  },\n\n  onInput(e) {\n    this.setData({\n      otherNeed: e.detail\n    });\n  },\n\n  onClickSubmit() {\n    if (this.lock) {\n      return;\n    }\n\n    const {\n      date,\n      addressId,\n      otherNeed,\n      tryTypes\n    } = this.data;\n\n    if (!date) {\n      return Toast('请选择日期');\n    }\n\n    if (!addressId) {\n      return Toast('请选择地址');\n    }\n\n    let count = 0;\n    tryTypes.forEach(item => {\n      if (item.active) {\n        count++;\n      }\n    });\n\n    if (!count) {\n      return Toast('请选择想试戴的品类');\n    }\n\n    this.lock = true;\n    Toast.loading('提交中...');\n    const submitDate = [date.slice(0, 4), date.slice(4, 6), date.slice(6, 8)].join('-');\n    let tryTypesResult = '';\n    tryTypes.forEach(item => {\n      if (item.active) {\n        tryTypesResult += item.text + '、';\n      }\n    });\n    tryTypesResult = tryTypesResult.slice(0, -1);\n\n    if (this.edit) {\n      // 编辑\n      request({ ...api.order_update,\n        id: this.id\n      }, {\n        send_address_id: addressId,\n        recomanded_send_time: submitDate,\n        preferred_product_type: tryTypesResult,\n        user_note: otherNeed\n      }).then(() => {\n        Toast.success('提交成功');\n        wx.setStorageSync('questionState', null);\n        this.lock = false;\n        wx.switchTab({\n          url: '/pages/box/index'\n        });\n      }).catch(err => {\n        Toast(err.message || err.msg || err || '提交失败');\n        this.lock = false;\n      });\n    } else {\n      // 新建\n      // state 数据刷新\n      this.state.date = this.data.date;\n      this.state.tryTypes = this.data.tryTypes;\n      this.state.addressId = addressId;\n      this.state.addressInfo = this.data.addressInfo;\n      this.state.otherNeed = otherNeed; // 问卷数据刷新\n\n      this.list[22].value = addressId;\n      this.list[23].value = submitDate;\n      this.list[24].value = tryTypesResult;\n      this.list[25].value = otherNeed;\n      request(api.survey_submit, {\n        state: JSON.stringify(this.state),\n        survey_tag_list: this.list\n      }).then(() => {\n        Toast.success('提交成功');\n        this.lock = false;\n        wx.setStorageSync('questionState', null);\n        request(api.info).then(res => {\n          if (res.user.status === 2 || res.user.status === 4) {\n            wx.switchTab({\n              url: '/pages/box/index'\n            });\n          } else {\n            wx.navigateTo({\n              url: '/packages/membership/index'\n            });\n          }\n        }).catch(err => {\n          Toast(err.message || '获取用户数据失败');\n        });\n      }).catch(err => {\n        Toast(err.message || err.msg || err || '提交失败');\n        this.lock = false;\n      });\n    }\n  },\n\n  onShareAppMessage() {\n    return {\n      title: '爱戴小盒，快来看看吧!',\n      path: '/pages/entry/index',\n      imageUrl: 'http://static.wx.qiaqiabox.com/slice/share/1.jpeg'\n    };\n  }\n\n});",null]}